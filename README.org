#+TITLE: Nix configuration
#+AUTHOR: psyclyx
#+PROPERTY: header-args:emacs-lisp :lexical t
#+STARTUP: content

* nixos-anywhere
#+begin_src shell
  TEMP=$(mktemp -d nixos-anywhere-temp.XXXXXXX)

  # ssh keys

  for d in {"${TEMP}/etc/ssh","${TEMP}/etc/secrets/initrd"}; do
    install -d -m755 "${d}"
    ssh-keygen -o -a 100 -N "" -t ed25519 -f "${d}/ssh_host_ed25519_key"
  done


  # FDE keys
  BW_FOLDER="foo/bar";
  BW_ITEM="baz";
  FDE_REMOTE="/tmp/baz.key"
  FDE_LOCAL=$(mktemp "nixos-anywhere-temp-${BW_ITEM}.XXXXXXX")

  bw get password $(bw list items --search "${BW_ITEM}" --folderid $(bw get folder "${BW_FOLDER}" | jq '.id' --raw-output) | jq '.[0].id' --raw-output) >! "${FDE_LOCAL}"

  # install

  NA_HOSTNAME="example"
  NA_HOST="10.0.0.250"

  nix run github:nix-community/nixos-anywhere -- \
    --flake "github:psyclyx/nix#${NA_HOSTNAME}" \
    --target-host "{NA_HOST}" \
    --extra-files "${TEMP}" \
    --disk-encryption-keys "${FDE_REMOTE}" "${FDE_LOCAL}"


  # clean up

  rm -r "${TEMP}"
  rm "${FDE_LOCAL}"
#+end_src
